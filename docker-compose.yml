version: "2.4"

services:
  proxy:
    build: ./proxy
    restart: unless-stopped
    network_mode: host
    volumes:
      - proxy_certs:/etc/haproxy/certs
    environment:
      - HAPROXY_CERT_CN=${HAPROXY_CERT_CN:-openclaw.local}
    depends_on:
      - openclaw

  openclaw:
    build: ./gateway
    restart: unless-stopped
    network_mode: host
    volumes:
      - openclaw_data:/data
      - openclaw_home:/root

    environment:
      # ═══════════════════════════════════════════════════════════════════
      # IMPORTANT: ALL environment variables set in Balena Cloud will be
      # automatically passed to OpenClaw and written to ~/.openclaw/.env
      #
      # You can configure any provider, integration, or setting via Balena
      # Device Variables, then control which ones to use in openclaw.json
      # ═══════════════════════════════════════════════════════════════════

      # --- Core OpenClaw settings ---
      # Auto-generated if empty (see start.sh), but users can set via Device Variables:
      - OPENCLAW_GATEWAY_TOKEN=

      # OpenClaw gateway listen settings (internal, behind HAProxy)
      - OPENCLAW_GATEWAY_PORT=8080
      - OPENCLAW_GATEWAY_HOST=127.0.0.1

      # --- Runtime update & extensibility ---
      # Set a specific version to upgrade/downgrade at next restart (e.g. "2026.2.6-3").
      # Leave empty to keep the version baked into the image.
      - OPENCLAW_VERSION=

      # Number of version snapshots to keep for rollback (default: 3)
      - OPENCLAW_KEEP_VERSIONS=3

      # Comma-separated ClawHub skill slugs to install at boot (e.g. "home-assistant,web-search")
      - OPENCLAW_SKILLS=

      # Comma-separated plugin npm packages to install at boot (e.g. "@openclaw/voice-call")
      - OPENCLAW_PLUGINS=

      # --- Example provider API keys (set via balena Device Variables) ---
      # All environment variables are automatically exported to OpenClaw.
      # These are just examples - add any variables you need in Balena Cloud:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}

volumes:
  openclaw_data:
  openclaw_home:
  proxy_certs:
