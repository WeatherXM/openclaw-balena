global
    log stdout format raw local0 warning
    maxconn 256

defaults
    log     global
    mode    http
    option  dontlognull
    timeout connect 5s
    timeout client  30s
    timeout server  30s
    timeout tunnel  3600s

frontend http_in
    bind *:80
    # Balena public URL proxies HTTPS->HTTP to port 80; pass through as-is
    acl is_balena_public hdr_end(Host) -i balena-devices.com
    use_backend openclaw_gateway if is_balena_public
    # All other HTTP: redirect to HTTPS (LAN access)
    http-request redirect scheme https code 301 unless is_balena_public

frontend https_in
    bind *:443 ssl crt /etc/haproxy/certs/self-signed.pem
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Real-IP %[src]
    # Rewrite Origin/Host so the gateway sees requests as local
    # (avoids origin check when behind reverse proxy)
    http-request set-header Host 127.0.0.1:8080
    http-request set-header Origin http://127.0.0.1:8080
    default_backend openclaw_gateway

backend openclaw_gateway
    server gateway 127.0.0.1:8080 check
